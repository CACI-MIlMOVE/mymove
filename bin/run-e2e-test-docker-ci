#!/bin/bash

set -eu -o pipefail

# Setting REACT_APP_NODE_ENV to develompent enables the "Local Sign In" button
export REACT_APP_NODE_ENV=development

# Set the container default name
CONTAINER=e2e

# Change the port for tests
HTTP_PORT=4000

make server_deps server_generate client_build db_e2e_init server_build

# Build the docker container
docker build --tag e2e:latest .

# Build the migration docker container
docker build -f Dockerfile.migrations --build-arg environment=test --tag e2e_migrations:latest .

# Run the migrations before starting the container
docker run \
  --name="${CONTAINER}_migrations" \
  --link="db-dev:database" \
  --detach \
  e2e_migrations:latest

# Debug output
docker ps -a
echo
docker logs ${CONTAINER}_migrations
echo

# Run the image with the ports changed
docker run \
  -e CLIENT_AUTH_SECRET_KEY \
  -e DB_HOST="database" \
  -e DB_NAME \
  -e DB_PASSWORD \
  -e DB_PORT \
  -e DB_USER \
  -e DOD_CA_PACKAGE="/config/tls/Certificates_PKCS7_v5.4_DoD.der.p7b" \
  -e ENV="test" \
  -e HERE_MAPS_APP_CODE \
  -e HERE_MAPS_APP_ID \
  -e HERE_MAPS_GEOCODE_ENDPOINT \
  -e HERE_MAPS_ROUTING_ENDPOINT \
  -e IWS_RBS_HOST \
  -e LOGIN_GOV_CALLBACK_PORT="${HTTP_PORT}" \
  -e LOGIN_GOV_CALLBACK_PROTOCOL \
  -e LOGIN_GOV_HOSTNAME \
  -e LOGIN_GOV_MY_CLIENT_ID \
  -e LOGIN_GOV_OFFICE_CLIENT_ID \
  -e LOGIN_GOV_SECRET_KEY \
  -e LOGIN_GOV_TSP_CLIENT_ID \
  -e MOVE_MIL_DOD_CA_CERT \
  -e MOVE_MIL_DOD_TLS_CERT \
  -e MOVE_MIL_DOD_TLS_KEY \
  -e NO_TLS_PORT="${HTTP_PORT}" \
  -e SECURE_MIGRATION_DIR \
  -e SECURE_MIGRATION_SOURCE \
  -p "${HTTP_PORT}" \
  --expose="${HTTP_PORT}" \
  --name="${CONTAINER}" \
  --link="db-dev:database" \
  --detach \
  e2e:latest

# Debug output
docker ps -a
echo
docker logs ${CONTAINER}
echo

npx cypress run & p2=$!

wait $p2
test_exit=$?
echo "Test exited with code $test_exit"
exit $test_exit
