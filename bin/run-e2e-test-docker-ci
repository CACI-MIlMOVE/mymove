#!/bin/bash

set -eu -o pipefail

# Setting REACT_APP_NODE_ENV to develompent enables the "Local Sign In" button
export REACT_APP_NODE_ENV=development

# Set the container default name
CONTAINER=e2e

# Change the port for tests
HTTP_PORT=4000

make server_deps server_generate client_build db_e2e_init server_build

# Build the docker container
docker build --tag e2e:latest .

# Run the image with the ports changed
docker run \
  -e CLIENT_AUTH_SECRET_KEY \
  -e DB_HOST="database" \
  -e DB_NAME \
  -e DB_PASSWORD \
  -e DB_PORT \
  -e DB_USER \
  -e DOD_CA_PACKAGE="/config/tls/Certificates_PKCS7_v5.4_DoD.der.p7b" \
  -e ENV="test" \
  -e HERE_MAPS_APP_CODE \
  -e HERE_MAPS_APP_ID \
  -e HERE_MAPS_GEOCODE_ENDPOINT \
  -e HERE_MAPS_ROUTING_ENDPOINT \
  -e HTTP_MY_SERVER_NAME="mylocal" \
  -e IWS_RBS_HOST \
  -e LOGIN_GOV_CALLBACK_PORT="${HTTP_PORT}" \
  -e LOGIN_GOV_CALLBACK_PROTOCOL \
  -e LOGIN_GOV_HOSTNAME \
  -e LOGIN_GOV_MY_CLIENT_ID \
  -e LOGIN_GOV_OFFICE_CLIENT_ID \
  -e LOGIN_GOV_SECRET_KEY \
  -e LOGIN_GOV_TSP_CLIENT_ID \
  -e MOVE_MIL_DOD_CA_CERT \
  -e MOVE_MIL_DOD_TLS_CERT \
  -e MOVE_MIL_DOD_TLS_KEY \
  -e NO_TLS_PORT="${HTTP_PORT}" \
  -e SECURE_MIGRATION_DIR \
  -e SECURE_MIGRATION_SOURCE \
  -p "${HTTP_PORT}:${HTTP_PORT}" \
  --expose="${HTTP_PORT}" \
  --name="${CONTAINER}" \
  --link="db-dev:database" \
  --detach \
  e2e:latest

# Debug output
docker ps -a
echo
docker logs ${CONTAINER}
echo
E2E_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' e2e)

# Run the cypress tests
docker build -f Dockerfile.cypress --tag cypress:latest .
docker run \
  -e CYPRESS_baseUrl=https://mylocal:4000 \
  --add-host mylocal:"${E2E_IP}" \
  --add-host officelocal:"${E2E_IP}" \
  --add-host tsplocal:"${E2E_IP}" \
  --name="cypress" \
  --link="${CONTAINER}" \
  --detach \
  cypress:latest

docker logs -f cypress

# Copy out the results
docker cp cypress:/cypress/videos cypress/
docker cp cypress:/cypress/screenshots cypress/
docker cp cypress:/cypress/results cypress/

# Grab the exit code
EXIT_STATUS=$(docker inspect cypress --format='{{.State.ExitCode}}')
exit "${EXIT_STATUS}"
