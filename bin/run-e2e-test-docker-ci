#!/bin/bash

set -eu -o pipefail

# Setting REACT_APP_NODE_ENV to develompent enables the "Local Sign In" button
export REACT_APP_NODE_ENV=development

make server_deps server_generate client_build db_e2e_init server_build

# Build the docker container
docker build --tag e2e:latest .

export HTTP_PORT=4000

# Ensure this container doesn't exist
CONTAINER=e2e_test

function kill_container() {
  echo "Stopping container $CONTAINER"
  docker stop $CONTAINER || true
  echo "Removing container $CONTAINER"
  docker rm $CONTAINER || true
}
kill_container

# Run the image with the ports changed
docker run \
  -e CLIENT_AUTH_SECRET_KEY="$CLIENT_AUTH_SECRET_KEY" \
  -e DB_HOST="database" \
  -e DB_NAME="test_db" \
  -e DB_PASSWORD="$DB_PASSWORD" \
  -e DB_PORT="$DB_PORT" \
  -e DB_USER="$DB_USER" \
  -e DOD_CA_PACKAGE="/config/tls/Certificates_PKCS7_v5.4_DoD.der.p7b" \
  -e ENV="test" \
  -e HERE_MAPS_APP_CODE="$HERE_MAPS_APP_CODE" \
  -e HERE_MAPS_APP_ID="$HERE_MAPS_APP_ID" \
  -e HERE_MAPS_GEOCODE_ENDPOINT="$HERE_MAPS_GEOCODE_ENDPOINT" \
  -e HERE_MAPS_ROUTING_ENDPOINT="$HERE_MAPS_ROUTING_ENDPOINT" \
  -e IWS_RBS_HOST="$IWS_RBS_HOST" \
  -e LOGIN_GOV_CALLBACK_PORT="$HTTP_PORT" \
  -e LOGIN_GOV_CALLBACK_PROTOCOL="$LOGIN_GOV_CALLBACK_PROTOCOL" \
  -e LOGIN_GOV_HOSTNAME="$LOGIN_GOV_HOSTNAME" \
  -e LOGIN_GOV_MY_CLIENT_ID="$LOGIN_GOV_MY_CLIENT_ID" \
  -e LOGIN_GOV_OFFICE_CLIENT_ID="$LOGIN_GOV_OFFICE_CLIENT_ID" \
  -e LOGIN_GOV_SECRET_KEY="$LOGIN_GOV_SECRET_KEY" \
  -e LOGIN_GOV_TSP_CLIENT_ID="$LOGIN_GOV_TSP_CLIENT_ID" \
  -e MOVE_MIL_DOD_CA_CERT="$MOVE_MIL_DOD_CA_CERT" \
  -e MOVE_MIL_DOD_TLS_CERT="$MOVE_MIL_DOD_TLS_CERT" \
  -e MOVE_MIL_DOD_TLS_KEY="$MOVE_MIL_DOD_TLS_KEY" \
  -e NO_TLS_PORT="$HTTP_PORT" \
  -e PORT="$HTTP_PORT" \
  -e SECURE_MIGRATION_DIR="$SECURE_MIGRATION_DIR" \
  -e SECURE_MIGRATION_SOURCE="$SECURE_MIGRATION_SOURCE" \
  -p "$HTTP_PORT":"$HTTP_PORT" \
  --link=db-dev:database \
  --name=e2e_test \
  e2e:latest & p1=$!

echo "Running docker process $p1"
docker ps -a

npx cypress run & p2=$!

wait $p2
test_exit=$?
echo "Test exited with code $test_exit"

# Kill the docker container you built
kill_container

exit $test_exit
