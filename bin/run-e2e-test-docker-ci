#!/bin/bash

set -eu -o pipefail

# Setting REACT_APP_NODE_ENV to develompent enables the "Local Sign In" button
export REACT_APP_NODE_ENV=development

make server_deps server_generate client_build db_e2e_init_circleci server_build

# Build the docker container
docker build --tag e2e:latest .

HTTP_PORT=4000

# Ensure this container doesn't exist
CONTAINER=e2e_test

# Run the image with the ports changed
docker run \
  -e CLIENT_AUTH_SECRET_KEY="$CLIENT_AUTH_SECRET_KEY" \
  -e DB_HOST="$DB_HOST" \
  -e DB_NAME="$DB_NAME" \
  -e DB_PASSWORD="$DB_PASSWORD" \
  -e DB_PORT="$DB_PORT" \
  -e DB_USER="$DB_USER" \
  -e DOD_CA_PACKAGE="/config/tls/Certificates_PKCS7_v5.4_DoD.der.p7b" \
  -e ENV="test" \
  -e HERE_MAPS_APP_CODE="$HERE_MAPS_APP_CODE" \
  -e HERE_MAPS_APP_ID="$HERE_MAPS_APP_ID" \
  -e HERE_MAPS_GEOCODE_ENDPOINT="$HERE_MAPS_GEOCODE_ENDPOINT" \
  -e HERE_MAPS_ROUTING_ENDPOINT="$HERE_MAPS_ROUTING_ENDPOINT" \
  -e IWS_RBS_HOST="$IWS_RBS_HOST" \
  -e LOGIN_GOV_CALLBACK_PORT="$HTTP_PORT" \
  -e LOGIN_GOV_CALLBACK_PROTOCOL="$LOGIN_GOV_CALLBACK_PROTOCOL" \
  -e LOGIN_GOV_HOSTNAME="$LOGIN_GOV_HOSTNAME" \
  -e LOGIN_GOV_MY_CLIENT_ID="$LOGIN_GOV_MY_CLIENT_ID" \
  -e LOGIN_GOV_OFFICE_CLIENT_ID="$LOGIN_GOV_OFFICE_CLIENT_ID" \
  -e LOGIN_GOV_SECRET_KEY="$LOGIN_GOV_SECRET_KEY" \
  -e LOGIN_GOV_TSP_CLIENT_ID="$LOGIN_GOV_TSP_CLIENT_ID" \
  -e MOVE_MIL_DOD_CA_CERT="$MOVE_MIL_DOD_CA_CERT" \
  -e MOVE_MIL_DOD_TLS_CERT="$MOVE_MIL_DOD_TLS_CERT" \
  -e MOVE_MIL_DOD_TLS_KEY="$MOVE_MIL_DOD_TLS_KEY" \
  -e NO_TLS_PORT="$HTTP_PORT" \
  -e SECURE_MIGRATION_DIR="$SECURE_MIGRATION_DIR" \
  -e SECURE_MIGRATION_SOURCE="$SECURE_MIGRATION_SOURCE" \
  -p "$HTTP_PORT":"$HTTP_PORT" \
  --expose="$HTTP_PORT" \
  --name="$CONTAINER" \
  --detach \
  e2e:latest

# Debug output
docker ps -a
echo
docker logs $CONTAINER
echo
ip=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' $CONTAINER)
echo "$ip"
echo
nmap -p"$HTTP_PORT,9443,8443,5432" -Pn -oG - "$ip"
echo

npx cypress run & p2=$!

wait $p2
test_exit=$?
echo "Test exited with code $test_exit"
exit $test_exit
