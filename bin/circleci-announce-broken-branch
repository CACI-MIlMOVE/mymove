#!/bin/bash
set -euo pipefail

GIT_TEXT=$(git --no-pager show --format=format:'%s')
NOW=$(date '+%s')
NOW_ISO8601=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

message="The $CIRCLE_PROJECT_REPONAME $CIRCLE_BRANCH branch broke on job $CIRCLE_JOB! Contact $CIRCLE_USERNAME for more information."

#####
## Announce in Slack channel
#####
# 'color' can be any hex code or the key words 'good', 'warning', or 'danger'
color="warning"
if [[ $CIRCLE_JOB == *"deploy"* ]]; then
  color="danger"
fi

slack_payload=$(
cat <<EOM
{
    "channel": "#dp3-engineering",
    "attachments": [
        {
            "fallback": "$message $CIRCLE_BUILD_URL",
            "color": "$color",
            "pretext": "$message",
            "title": "CircleCI job $CIRCLE_JOB #$CIRCLE_BUILD_NUM",
            "title_link": "$CIRCLE_BUILD_URL",
            "text": "$GIT_TEXT",
            "ts": $NOW
        }
    ]
}
EOM
)
curl -X POST --data-urlencode payload="$slack_payload" "$SLACK_WEBHOOK_URL"

#####
## Page the on-call via PagerDuty
#####

pd_payload=$(
cat <<EOM
{
  "payload": {
    "summary": "$message",
    "timestamp": "$NOW_ISO8601",
    "source": "CircleCI job $CIRCLE_JOB #$CIRCLE_BUILD_NUM",
    "severity": "info",
    "class": "cicd failure"
  },
  "routing_key": "$PD_ROUTING_KEY",
  "dedup_key": "circle-$CIRCLE_WORKFLOW_ID",
  "links": [{
    "href": "$CIRCLE_BUILD_URL",
    "text": "CircleCI Build URL"
  }],
  "event_action": "trigger"
}
EOM
)

echo "$pd_payload"
echo

# curl -XPOST \
#   -H "Authorization: Token token=$PD_AUTH_TOKEN" \
#   -H "Accept: application/vnd.pagerduty+json;version=2" \
#   -H "Content-Type: application/json" \
#   --data "$pd_payload" \
#   "https://events.pagerduty.com/v2/enqueue"
