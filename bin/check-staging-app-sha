#!/bin/bash
set -euo pipefail

circle_sha=$1
if [ -z "$circle_sha" ]; then
  echo "Missing the '$'CIRCLE_SHA1"
  exit 1
fi

staging_sha=$(curl "https://my.staging.move.mil/health" --silent | jq ".gitCommit" --raw-output)

if [[ $(git rev-list --count "$staging_sha".."$circle_sha") == 0 ]]; then
  echo "staging SHA $staging_sha is newer than circle SHA $circle_sha"
  circleci step halt
else
  echo "Checked shas; staging SHA $staging_sha is older than circle SHA $circle_sha"
fi
